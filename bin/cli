#!/usr/bin/env node

const pm2 = require('pm2');
const program = require('commander')
const prompt = require('co-prompt')
const co = require('co')
const chalk = require('chalk')
const chokidar = require('chokidar');
const webpack = require("../node_modules/webpack");
const download = require("download-git-repo");
const fs = require('fs');
const rm = require('rimraf');
const config = require('../config/config.js');

//检测文件或者文件夹存在 nodeJS
function fsExistsSync(path) {
    try{
        fs.accessSync(path,fs.F_OK);
    }catch(e){
        return false;
    }
    return true;
}
function initFiles(downLoadPath, appName, fileMap) {
    console.log(chalk.white('\n Start generating...'));
    download(downLoadPath, './' + appName, function (err) {
        if (err) {
            console.log(err)
            process.exit()
        }
        console.log(chalk.white('\n download file completed!'));
        rm(appName + '/.git', err => {
            if (err) {
                throw err;
            }
            console.log(chalk.white('\n remove .git completed!'));
            try {
                for (let i = 0; i < fileMap.length; i++) {
                    if (fsExistsSync(fileMap[i])) {
                        let text = fs.readFileSync(fileMap[i], 'utf-8');
                        text = text.replace(/\$_appname/g, appName);
                        fs.writeFileSync(fileMap[i], text);
                    }
                }
                console.log(chalk.white('\n replace file completed!'));
                console.log(chalk.green('\n √ Generation completed!'))
                console.log(`\n cd ${appName} && npm install \n`)
                process.exit()
            } catch (e) {
                console.log(e)
                process.exit()
            }
        });
    })
}
function restartApp(app, cb) {
    pm2.connect(function(err) {
        if (err) {
            console.error(err);
            process.exit(2);
        }

        pm2.restart(app, function(err, apps) {
            pm2.disconnect(); // Disconnects from PM2
            if (err) {
                // throw err;
                process.exit()
            }
            console.log(chalk.green('\n √ Restart completed!'));
            if (cb && typeof cb === 'function') {
                cb();
            }
        });
    });
}

function copyDir(src, dist) {
    if (!fsExistsSync(dist)) {
        fs.mkdirSync(dist);
    }
    let paths = fs.readdirSync(src);
     
    paths.forEach(function(path) {
        var _src = src + '/' +path;
        var _dist = dist + '/' +path;
        let stat = fs.lstatSync(_src);
        if (stat.isDirectory()) {
            // 当是目录，递归复制
            copyDir(_src, _dist)
        } else {
            fs.writeFileSync(_dist, fs.readFileSync(_src));
        }
    })
}

function moveAppToPro(appName, fileMap) {
    for (let i in fileMap) {
        if (fsExistsSync(i + appName)) {
            if (!fsExistsSync(fileMap[i])) {
                fs.mkdirSync(fileMap[i]);
                copyDir(i + appName, fileMap[i] + appName);
            } else {
                copyDir(i + appName, fileMap[i] + appName);
            }
        }
    }
    rm.sync('./build');
    console.log(chalk.white('\n √ Remove build completed!'));
    console.log(chalk.green('\n √ Deploy completed!'));
}

program
    .version('1.3.0')
program
    .command('init <option>')
    .description('Generate a new app')
    .action((option) => {
        co(function*() {
            let appName = yield prompt(option + ' name: ');
            let fileMap = config[option].fileMap(appName);
            let downloadPath = config[option].downloadPath;
            initFiles(downloadPath, appName, fileMap);
        });
    });

program
    .command('run')
    .description('start the bun')
    .action(() => {
        co(function*() {
            console.log(chalk.white('\n Starting bunko...'))
            pm2.connect(function(err) {
                if (err) {
                    console.error(err);
                    process.exit(2);
                }

                pm2.start(process.cwd() + '/ecosystem.config.js', function(err, apps) {
                    pm2.disconnect(); // Disconnects from PM2
                    if (err) {
                        throw err;
                        process.exit()
                    }
                    console.log(chalk.green('\n √ Starting completed!'))
                    process.exit()
                    
                });
            });
        })
    })

program
    .command('restart <app>')
    .description('restart the bun')
    .action((app) => {
        co(function*() {
            restartApp(app);
        })
    })
program
    .command('stop <app>')
    .description('stop the bun')
    .action((app) => {
        co(function*() {

            pm2.connect(function(err) {
                if (err) {
                    console.error(err);
                    process.exit(2);
                }

                pm2.stop(app, function(err, apps) {
                    pm2.disconnect(); // Disconnects from PM2
                    if (err) {
                        throw err;
                        process.exit()
                    }
                    console.log(chalk.green('\n √ Stoping completed!'))
                    process.exit()
                    
                });
            });
        })
    })
program
    .command('rundev')
    .description('start mock server')
    .action(() => {
        co(function*() {
            let userConf = require(process.cwd() + '/config.js');
            userConf.hotMiddleware = true;
            require('../dev-server/server.js')(userConf);
        })
    })
function webpackBuild(webpackConfig) {
    return new Promise((resolve, reject) => {
        webpack(webpackConfig, (err, stats) => {
            // 在这里处理错误
            if (err) {
                console.error(err.stack || err);
                if (err.details) {
                  console.error(err.details);
                }
                process.exit();
            }

            const info = stats.toJson();

            if (stats.hasErrors()) {
                console.error(info.errors);
                process.exit();
            }

            if (stats.hasWarnings()) {
                console.warn(info.warnings);
            }
            // if (err || stats.hasErrors()) {
            //     // 在这里处理错误
            //     console.log(stats)
            //     process.exit()
            // }
            console.log(stats.toString({
                // 增加控制台颜色开关
                colors: true
            }));
            console.log(chalk.green('\n √ Complier completed!'));
            resolve(stats);
        });
    });
}
program
    .command('release')
    .description('deploy the app')
    .alias('r')
    .option("-d, --dev", "if development")
    .option("-t, --to [path]", "Which project to deploy")
    .option("-w, --watch", "if watching the app")
    .option("-c, --test", "dev=test")
    .action((options) => {
        co(function*() {
            let path = options.to;
            let dev = options.dev;
            let test = options.test;
            let ssr = options.ssr;
            let userConf = require(process.cwd() + '/config.js');
            let webpackConfig = '';
            let vueSsrWebpackConfig = '';
            if (dev) {
                process.env.NODE_ENV === 'development';
                webpackConfig = require('../config/webpack.config-dev.js')(userConf);
            } else {
                process.env.NODE_ENV === 'production';
                if (test) {
                    userConf.publicStaticDomain = userConf.testStaticDomain;
                }
                webpackConfig = require('../config/webpack.config.js')(userConf);
            }
            if (userConf.ssr) {
                vueSsrWebpackConfig = require('../config/webpack.config-vuessr.js')(userConf);
            }
            function moveToProAndWatch() {
                // 如果设置to参数，则移动build目录下的文件到指定project
                let files = fs.readdirSync('./build/server/');
                let appName = files[0];
                let fileMap = config.deployConf.fileMap(path);
                moveAppToPro(appName, fileMap);
                let projectName = path.replace(/[\.\.\/]*([/s/S]*)\/?/ig, '$1');

                restartApp(projectName, () => {
                    if (options.watch) {
                        // 使用chokidar监控app文件变化，自动部署，仅限线下调试使用
                        const watcher = chokidar.watch([process.cwd() + '/server', process.cwd() + '/src', process.cwd() + '/conf']);
                        watcher.on('change', (path, stats) => {
                            if (stats) console.log(chalk.green(`File ${path} changed size to ${stats.size}`));
                            webpackBuild(webpackConfig).then(() => {
                                if (userConf.ssr) {
                                    webpackBuild(vueSsrWebpackConfig).then((stats) => {
                                        if (path) {
                                            // 如果设置to参数，则移动build目录下的文件到指定project
                                            moveAppToPro(appName, fileMap);
                                            restartApp(projectName);
                                        }
                                    });
                                } else if (path) {
                                    moveAppToPro(appName, fileMap);
                                    restartApp(projectName);
                                }
                            });
                        });
                    } else {
                        process.exit();
                    }
                });
            }

            console.log(chalk.white('\n Start deploying...'));
            webpackBuild(webpackConfig).then((stats) => {
                try {
                    if (userConf.ssr) {
                        webpackBuild(vueSsrWebpackConfig).then((stats) => {
                            if (path) {
                                moveToProAndWatch();
                            }
                        });
                    } else {
                        if (path) {
                            moveToProAndWatch();
                        } 
                    }
                } catch (e) {
                    console.log(e)
                    process.exit()
                }
            });
        })
    })

program.parse(process.argv);